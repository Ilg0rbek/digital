<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <%- include('../partials/head.ejs') %>
    <link rel="stylesheet" href="css/digital.css" />
    <title><%= title %></title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="index-page layout">
    <%- include('../partials/navbar.ejs') %>

    <main class="main" style="background: #f8fafc;">
      <!-- Top Banner -->
      <div class="container py-5">
        <div>
            <div class="container py-5">
              <div class="row align-items-center mt-5">
                <div class="col-md-8">
                  <h1 class="h3 mb-0">Loyiha yuklash</h1>
                </div>
                <div class="col-md-4 text-md-end">
                  <a href="/files/b-mezon.docx" download="b-mezon.docx" class="btn btn-light btn-sm">
                    <i class="bi bi-download me-2"></i>
                    Baholash mezonlari bilan tanishish
                  </a>
                </div>
              </div>
            </div>
          </div>
        <div class="row">
          <!-- Progress Steps -->
          <div class="col-lg-3 mb-4" data-aos="fade-right">
            <div class="steps-container">
              <div class="step active">
                <div class="step-icon">
                  <i class="bi bi-1-circle-fill"></i>
                </div>
                <div class="step-content">
                  <h6>Loyiha ma'lumotlari</h6>
                  <p class="small text-muted">Asosiy ma'lumotlarni kiriting</p>
                </div>
              </div>
              <div class="step">
                <div class="step-icon">
                  <i class="bi bi-2-circle"></i>
                </div>
                <div class="step-content">
                  <h6>Rasmlar</h6>
                  <p class="small text-muted">Loyiha rasmlarini yuklang</p>
                </div>
              </div>
              <div class="step">
                <div class="step-icon">
                  <i class="bi bi-3-circle"></i>
                </div>
                <div class="step-content">
                  <h6>Fayllar</h6>
                  <p class="small text-muted">Loyiha fayllarini yuklang</p>
                </div>
              </div>
              <div class="step">
                <div class="step-icon">
                  <i class="bi bi-4-circle"></i>
                </div>
                <div class="step-content">
                  <h6>Tekshirish</h6>
                  <p class="small text-muted">Ma'lumotlarni tekshiring</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Form -->
          <div class="col-lg-9" data-aos="fade-left">
            <div class="card border-0 shadow-sm">
              <div class="card-body p-4">
                <form id="projectUploadForm" enctype="multipart/form-data">
                  <!-- Project Category -->
                  <div class="form-group mb-4">
                    <label class="form-label d-flex align-items-center">
                      <i class="bi bi-folder me-2 text-primary"></i>
                      Loyiha kategoriyasi
                    </label>
                    <select class="form-select" id="project" name="project" required>
                      <option value="" selected disabled>Kategoriyani tanlang</option>
                      <% projects.forEach(project => { %>
                        <option value="<%= project._id %>"><%= project.title %></option>
                      <% }); %>
                    </select>
                  </div>

                  <!-- Project Name -->
                  <div class="form-group mb-4">
                    <label class="form-label d-flex align-items-center">
                      <i class="bi bi-pencil me-2 text-primary"></i>
                      Loyiha nomi
                    </label>
                    <input type="text" class="form-control" id="projectName" name="projectName" required>
                  </div>

                  <!-- Project Description -->
                  <div class="form-group mb-4">
                    <label class="form-label d-flex align-items-center">
                      <i class="bi bi-text-paragraph me-2 text-primary"></i>
                      Loyiha haqida ma'lumot
                    </label>
                    <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                  </div>

                  <!-- Project Images -->
                  <div class="form-group mb-4">
                    <label class="form-label d-flex align-items-center">
                      <i class="bi bi-image me-2 text-primary"></i>
                      Loyiha rasmlari
                    </label>
                    <div class="upload-zone" id="imageDropZone">
                      <div class="upload-content">
                        <i class="bi bi-cloud-upload display-4 text-primary"></i>
                        <p class="mt-3">Rasmlarni bu yerga tashlang yoki</p>
                        <input type="file" class="d-none" id="images" name="images" multiple accept="image/*" required>
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('images').click()">
                          Tanlash
                        </button>
                      </div>
                    </div>
                    <div id="imagePreview" class="mt-3 d-flex flex-wrap gap-2"></div>
                  </div>

                  <!-- Project Files -->
                  <div class="form-group mb-4">
                    <label class="form-label d-flex align-items-center">
                      <i class="bi bi-file-earmark me-2 text-primary"></i>
                      Loyiha fayllari
                    </label>
                    <div class="upload-zone" id="fileDropZone">
                      <div class="upload-content">
                        <i class="bi bi-cloud-upload display-4 text-primary"></i>
                        <p class="mt-3">Fayllarni bu yerga tashlang yoki</p>
                        <input type="file" class="d-none" id="projectFiles" name="projectFiles" multiple accept=".doc,.docx,.pdf,.pptx" required>
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('projectFiles').click()">
                          Tanlash
                        </button>
                      </div>
                    </div>
                    <div id="filePreview" class="mt-3"></div>
                    <div class="form-text mt-2">
                      <i class="bi bi-info-circle me-1"></i>
                      Qo'llab-quvvatlanadigan formatlar: DOC, DOCX, PDF, PPTX
                    </div>
                  </div>

                  <!-- Submit Button -->
                  <div class="text-end">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                      <i class="bi bi-cloud-upload me-2"></i>
                      Loyihani yuklash
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <a href="#" id="scroll-top" class="scroll-top">
      <i class="bi bi-arrow-up-short"></i>
    </a>

    <%- include('../partials/footer.ejs') %>

    <style>
      .steps-container {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
      }

      .step {
        display: flex;
        align-items: flex-start;
        padding: 1rem 0;
        border-left: 2px solid #e9ecef;
        margin-left: 1rem;
        position: relative;
      }

      .step:last-child {
        border-left: none;
      }

      .step.active {
        border-left-color: var(--bs-primary);
      }

      .step-icon {
        width: 2rem;
        height: 2rem;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: -1rem;
        font-size: 1.2rem;
        color: #6c757d;
      }

      .step.active .step-icon {
        color: var(--bs-primary);
      }

      .step-content {
        margin-left: 1rem;
      }

      .step-content h6 {
        margin: 0;
        font-weight: 600;
      }

      .upload-zone {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }

      .upload-zone:hover {
        border-color: var(--bs-primary);
        background: #f1f3f5;
      }

      .upload-content {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .form-group {
        position: relative;
      }

      .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .form-control, .form-select {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem;
      }

      .form-control:focus, .form-select:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
      }
    </style>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('projectUploadForm');
      const imageInput = document.getElementById('images');
        const fileInput = document.getElementById('projectFiles');
      const imagePreview = document.getElementById('imagePreview');
        const filePreview = document.getElementById('filePreview');
        const submitBtn = document.getElementById('submitBtn');

        // Handle image preview
      imageInput.addEventListener('change', function(e) {
        imagePreview.innerHTML = '';
          Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
              const div = document.createElement('div');
              div.className = 'position-relative';
              div.innerHTML = `
                <img src="${e.target.result}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
              `;
              imagePreview.appendChild(div);
            }
            reader.readAsDataURL(file);
          });
        });

        // Handle file preview
        fileInput.addEventListener('change', function(e) {
          filePreview.innerHTML = '';
          Array.from(e.target.files).forEach(file => {
            const div = document.createElement('div');
            div.className = 'alert alert-info d-flex align-items-center';
            div.innerHTML = `
              <i class="bi bi-file-earmark me-2"></i>
              <span>${file.name}</span>
            `;
            filePreview.appendChild(div);
          });
        });

        // Handle form submission
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          try {
            // Get the token from localStorage
            const token = localStorage.getItem('token');
            if (!token) {
              Swal.fire({
                icon: 'error',
                title: 'Avtorizatsiya talab qilinadi',
                text: 'Iltimos, tizimga kiring',
                confirmButtonText: 'OK'
              }).then(() => {
                window.location.href = '/login';
      });
              return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Yuklanmoqda...';

            const formData = new FormData(form);
            
            // Log form data for debugging
            console.log('Form data being sent:', {
              projectName: formData.get('projectName'),
              description: formData.get('description'),
              project: formData.get('project'),
              images: imageInput.files.length,
              projectFiles: fileInput.files.length
            });
            
            const response = await fetch('/api/project-uploads', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`
              },
              body: formData
            });

            const result = await response.json();

            if (!response.ok) {
              throw new Error(result.error || 'Xatolik yuz berdi');
            }

            if (result.success) {
              // Show success message
              Swal.fire({
                icon: 'success',
                title: 'Muvaffaqiyatli!',
                text: 'Loyiha muvaffaqiyatli yuklandi',
                confirmButtonText: 'OK'
              }).then((result) => {
                if (result.isConfirmed) {
                  window.location.href = '/projects';
                }
              });
            } else {
              throw new Error(result.error || 'Xatolik yuz berdi');
            }
          } catch (error) {
            console.error('Form submission error:', error);
            Swal.fire({
              icon: 'error',
              title: 'Xatolik!',
              text: error.message,
              confirmButtonText: 'OK'
            });
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>Loyihani yuklash';
          }
        });

        // Drag and drop functionality
        const dropZones = document.querySelectorAll('.upload-zone');

        dropZones.forEach(zone => {
          ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, preventDefaults, false);
          });

          function preventDefaults(e) {
        e.preventDefault();
            e.stopPropagation();
          }

          ['dragenter', 'dragover'].forEach(eventName => {
            zone.addEventListener(eventName, highlight, false);
          });

          ['dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, unhighlight, false);
      });

          function highlight(e) {
            zone.classList.add('border-primary');
          }

          function unhighlight(e) {
            zone.classList.remove('border-primary');
          }

          zone.addEventListener('drop', handleDrop, false);

          function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            const input = zone.querySelector('input[type="file"]');
            
            input.files = files;
            const event = new Event('change');
            input.dispatchEvent(event);
          }
        });
      });
    </script>
  </body>
</html>
